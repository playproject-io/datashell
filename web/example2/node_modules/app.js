const STATE = require('STATE')
const statedb = STATE(__filename)
const { sdb, get } = statedb(defaults)
/******************************************************************************
  APP
******************************************************************************/
const head = require('head')
const foot = require('foot')

module.exports = app

async function app(opts) {
  // ----------------------------------------
  // ID + JSON STATE
  // ----------------------------------------
  const { id, sdb } = await get(opts.sid) // hub is "parent's" io "id" to send/receive messages
  const { drive } = sdb
  const on = {
    css: inject,
    json: fill
  }
  // ----------------------------------------
  // TEMPLATE
  // ----------------------------------------
  const el = document.createElement('div')
  const shopts = { mode: 'closed' }
  const shadow = el.attachShadow(shopts)
  shadow.innerHTML = `<style></style>`
  const style = shadow.querySelector('style')
  const subs = await sdb.watch(onbatch)
  // ----------------------------------------
  // ELEMENTS
  // ----------------------------------------
  ;{ // nav
    shadow.append(await head(subs[0]), await foot(subs[1]))
  }
  return el

  async function onbatch(batch){
    for (const {type, paths} of batch) {
      const data = await Promise.all(paths.map(path => drive.get(path).then(file => file.raw)))
      on[type] && on[type](data)
    }
  }
  async function inject (data){
    style.innerHTML = data.join('\n')
  }
  async function fill([data]) {
  }
}
/******************************************************************************
  DEFAULTS
******************************************************************************/
function defaults () { // -> set database defaults or load from database
	return {
    api: fallback_instance,
    _: {
      "head": {
        $: ''
      },
      "foot": {
        $: ''
      },
    }
  }
  function fallback_instance () {
    return {
      _: {
        "head": {
          0: ''
        },
        "foot": {
          0: ''
        },
      }
    }
  }
}