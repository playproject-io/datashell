const STATE = require('STATE')
const statedb = STATE(__filename)
const { sdb, get } = statedb(defaults)
/******************************************************************************
  NAV
******************************************************************************/
delete require.cache[require.resolve('menu')]
const {menu, menu_hover} = require('menu')

module.exports = nav
async function nav(opts) {
  // ----------------------------------------
  // ID + JSON STATE
  // ----------------------------------------
  const { id, sdb } = await get(opts?.sid) // hub is "parent's" io "id" to send/receive messages
  const { drive } = sdb
  const on = {
    theme: inject,
    lang: fill
  }
  // ----------------------------------------
  // TEMPLATE
  // ----------------------------------------
  const el = document.createElement('div')
  const shopts = { mode: 'closed' }
  const shadow = el.attachShadow(shopts)
  shadow.innerHTML = `
    <nav>
      <div class="box">

      <div>
    </nav>
    <style></style>`
  const main = shadow.querySelector('nav')
  const div = shadow.querySelector('div')
  const style = shadow.querySelector('style')
  const subs = await sdb.watch(onbatch)
  // ----------------------------------------
  // ELEMENTS
  // ----------------------------------------
  { //menu
    main.append(await menu(subs[0]), await menu_hover(subs[1]))
  }
  return el

  async function onbatch(batch){
    for (const {type, paths} of batch) {
      const data = await Promise.all(paths.map(path => drive.get(path).then(file => file.raw)))
      on[type] && on[type](data)
    }
  }
  async function inject (data){
    style.innerHTML = data.join('\n')
  }
  async function fill([data]) {
    div.replaceChildren(...data.links.map(link => {
      const el = document.createElement('div')
      el.classList.add('title')
      el.innerHTML = link
      return el
    }))
  }
}
/******************************************************************************
  DEFAULTS
******************************************************************************/
function defaults () { // -> set database defaults or load from database
	return {
    api: fallback_instance,
    _: {
      'menu':{
        $: ''
      },
    }
  }
  function fallback_instance () {
    return {
      _: {
        'menu':{
          0: override_menu,
          mapping: { 'style': 'theme', 'lang': 'lang' },
        },
        'menu$hover': {
          0: override_menu_hover,
          mapping: { 'style': 'theme', 'lang': 'lang' },
        }
      },
      drive: {
        'theme/': {
          'style.css': {
            raw: `
              nav{
                display: flex;
                gap: 20px;
                padding: 20px;
                background: #4b6d6d;
                color: white;
                box-shadow: 0px 1px 6px 1px gray;
                margin: 5px;
              }
              .title{
                background: linear-gradient(currentColor 0 0) 0 100% / var(--underline-width, 0) .1em no-repeat;
                transition: color .5s ease, background-size .5s;
                cursor: pointer;
              }
              .box{
                display: flex;
                gap: 20px;
              }
              .title:hover{
                --underline-width: 100%
              }
            `
          }
        },
        'lang/': {
          'en-us.json': {
            raw: {
              links: ['Home', 'About', 'Contact']
            }
          }
        }
      }
    }
  }
  function override_menu (path, tools, [menu]) {
    console.log('override', {path})
    const data = menu()
    data.drive['lang/']['en-us.json'].raw = {
      title: 'Services',
      links: ['Marketing', 'Design', 'Web Dev', 'Ad Compaign']
    }
    return data
  }
  function override_menu_hover  (path, tools, [menu]) {
    console.log('override', {path})
    const data = menu()
    data.drive['lang/']['en-us.json'].raw = {
      title: 'Services#hover',
      links: ['Marketing', 'Design', 'Web Dev', 'Ad Compaign']
    }
    return data
  }
}