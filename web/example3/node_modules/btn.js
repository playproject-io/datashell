const STATE = require('STATE')
const statedb = STATE(__filename)
const { sdb, get } = statedb(fallback_module)

module.exports = btn
async function btn (opts) {
  const { id, sdb } = await get(opts.sid)
  const { drive } = sdb
  const on = {
    lang: fill,
    style: inject
  }

  const el = document.createElement('div')
  const shadow = el.attachShadow({ mode: 'closed' })
  shadow.innerHTML = `<button></button>`
  const sheet = new CSSStyleSheet()
  shadow.adoptedStyleSheets = [sheet]
  const button_el = shadow.querySelector('button')
  const subs = await sdb.watch(onbatch)

  button_el.onclick = btn_click
  return el
  async function onbatch (batch) {
    // for (const { type, data } of batch) {
    //   on[type] && on[type](data)
    // }
    for (const {type, paths} of batch) {
      const data = await Promise.all(paths.map(path => drive.get(path).then(file => file.raw)))
      on[type] && on[type](data)
    }
  }
  async function fill (data) {
    button_el.textContent = data[0].label
  }
  async function inject ([data]) {
    sheet.replaceSync(data)
  }
  async function btn_click(event) {
    const button_el = event.target
    let isToggled = button_el.dataset.toggled === 'true'
    if (isToggled) {
      button_el.style.backgroundColor = ''
      button_el.dataset.toggled = 'false'
    } else {
      button_el.style.backgroundColor = 'lightblue'
      button_el.dataset.toggled = 'true'
    }
  }
}
function fallback_module () {
  return {
    api: fallback_instance,
    drive: {
      lang: {
        'en-us.json': {
          raw: {
            label: 'Button'
          }
        }
      },
      style: {
        'theme.css': {
          raw: `
          button {
            padding: 8px 16px;
            margin: 0px 40px;
          }`
        }
      }
    }
  }
  function fallback_instance () {
    return {
      drive: {
        lang: {
          'en-us.json': {
            raw: {
              label: 'Button'
            }
          }
        },
        style: {
          'theme.css': {
            raw: `
            button {
              padding: 8px 16px;
              margin: 0px 40px;
            }`
          }
        }
      }
    }
  }
}